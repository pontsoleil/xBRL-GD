= デジタル会計帳簿のTidy data(整然としたデータ)アプローチ

== 仕訳入力例
総勘定元帳の仕訳入力用にTidy data(整然としたデータ)を定義する方法を検討します。 
次は、紙を現金で購入したときの仕訳入力例です。

.総勘定元帳仕訳入力
[cols="1,1,>1,>1,^1,3,^1,1,1,1", options="header"]
|==========
|日付 |明細行摘要 |借方 +
金額 |貸方 +
金額 |科目 +
番号 |科目名 ^|C ^|N ^|T ^|ID
|2009-04-03 |用紙 >|14,858 | >|754 |事務用消耗品費 |10 |札幌 |部門 |943-8-477
|2009-04-03 | >|742 | |191 |仮払消費税等 |10 |札幌 |部門 |943-8-477
|2009-04-03 |用紙 | >|15,600 |111 |現金 |0 |共通部門 |部門 |943-8-477
10+|Key C: ビジネスセグメントコード, N: ビジネスセグメント名, T: ビジネスセグメントタイプ
|==========

今回の検証で使用したデータは、今世紀初頭にPCA会計９V.2の仕訳データをXBRL-GL (XBRL 2.0a) に変換して出力したもので、架空の企業の１年間の記帳データ <<data>> です。
国際的な標準仕様で出力したデータは、その当時のプログラムを用いることなく数十年たっても確認することができます。
今回のTidy Dataアプローチで1/12以上の容量削減になりました（31MB → 2.4MB）。OIM-CSVもxBRLインスタンスですからタクソノミを使用したバリデーションやフォーミュラを使用した検証がCSVファイルでも可能です。

== WickhamnによるTidy Dataの例
.次は Wickham<<_1>>の例です。架空の実験に関するデータを一般的によく見られる形式で提供しています。
[quote, Headley Wickham, Tidy Data Journal of Statistical Software August 2014 Volume 59 Issue 10]
私たちの行と列の語彙は、2 つのテーブルが同じデータを表す理由を説明するのに十分ではありません。 外観に加えて、テーブルに表示される値の基本的なセマンティクスまたは意味を説明する方法が必要です。

.代表的な結果表
[cols="2,>1,>1", options="header"]
|===
| ^|処置 A ^|処置 B
|John Smith |- |2
|Jane Doe |16 |11
|Mary Johnson |3 |1
|===

.TTable 2 と同じ結果の異なる表現
[cols="2,>1,>1,>1", options="header"]
|====
| ^|John Smith ^|Jane Doe ^|Mary Johnson 
|処置 A |- |16 |3
|処置 B |2 |11 |1
|====

.Wickham<<_1>> の 2.2 節では、データのセマンティクスについて説明しています。 
[quote, Headley Wickham, Tidy Data Journal of Statistical Software August 2014 Volume 59 Issue 10]
データセットは値のコレクションです。 値は 2 つの方法で編成されます。 すべての _値_ は、 _変数_ と _観察_ に属します。 +
表 4 は、表 1 を再構成して、_値_、_変数_、および _観測_ をより明確にしています。  _変数_ は次のとおりです。 +
1. *個人*, ３つの取りうる値がある (John Smith, Mary Johnson, および Jane Doe) +
2. *処置*, ２つの取りうる値がある (A および B) +
3. *結果値*, 欠損値をどう位置付けるかで5つあるいは6つの値がある。 (-, 16, 3, 2, 11, 1).

.Table 1 と同じデータだが、列に変数、行に観測がある
[cols="2,^1,>1", options="header"]
|===
^|個人 ^|処置 ^|値
|John Smith |A |-
|Jane Doe |A |16
|Mary Johnson |A |3
|John Smith |B |2
|Jane Doe |B | 11
|Mary Johnson |B |1
|===

.Wickham<<_1>> は、表に表示される値の基本的なセマンティクスを記述するTidy data(整然としたデータ)を定義しています。
[quote, Headley Wickham, Tidy Data Journal of Statistical Software August 2014 Volume 59 Issue 10]
Tidy data(整然としたデータ)では: +
— 各変数が列を形成します。 +
— 各観測値が行を形成します。 +
— 観測単位の種類ごとに表が形成されます。 +

== 総勘定元帳の意味構造
Table 5 は、総勘定元帳の意味構造を示しています。 この階層データ構造は、変数がデジタル台帳でどのように編成されているかを表しています。
これを 1 つのTidy data(整然としたデータ)で表すことが目標です。

.Semantic structure of 総勘定元帳
[cols="3,^1,5,^1,3", options="header"]
|=====
^|ID ^|H ^|項目 ^|繰返 ^|データ型
|A25 |0 |総勘定元帳 |0..n |*集約*
|A25-01 |1 |&bullet;仕訳ID |1..1 |識別子
|A25-02 |1 |&bullet;仕訳番号 |0..1 |コード
|A25-09 |1 |&bullet;Header Description |0..1 |文字
|A25-10 (A25-A26) |1 |&bullet;総勘定元帳明細行 |1..n |*集約*
|A26-03 (A26-A09) |2 |&bullet;&bullet;勘定科目 |1..1 |*集約*
|A26-A09-01 |3 |&bullet;&bullet;&bullet;勘定科目番号 |1..1 |識別子
|A26-A09-02 |3 |&bullet;&bullet;&bullet;勘定科目名 |0..1 |文字
|A26-A09-05 |3 |&bullet;&bullet;&bullet;勘定科目タイプ |0..1 |コード
|A26-A09-06 |3 |&bullet;&bullet;&bullet;補助科目タイプ |0..1 |コード
|A25-A26-06 |2 |&bullet;&bullet;日付 |0..1 |日付
|A25-A26-08 |2 |&bullet;&bullet;仕訳タイプコード |0..1 |コード
|A25-A26-07 |2 |&bullet;&bullet;明細行番号 |0..1 |コード
|A25-A26-10 |2 |&bullet;&bullet;明細行摘要 |0..1 |文字
|A25-A26-11 |2 |&bullet;&bullet;源コード |0..1 |コード
|A25-A26-12 |2 |&bullet;&bullet;書類番号 |0..1 |コード
|A25-A26-14 |2 |&bullet;&bullet;書類日付 |0..1 |日付
|A25-A26-27 |2 |&bullet;&bullet;貸借区分 |0..1 |コード
|A26-18 (A26-A89) |2 |&bullet;&bullet;多通貨金額 |1..n |*集約*
|A26-A89-01 |3 |&bullet;&bullet;&bullet;金額 |1..1 |金額
|A26-A89-02 |3 |&bullet;&bullet;&bullet;通貨 |1..1 |コード
|A26-41 (A26-A01) |2 |&bullet;&bullet;ビジネスセグメント |1..n |*集約*
|A26-A01-03 |3 |&bullet;&bullet;&bullet;ビジネスセグメント区分 |1..1 |コード
|A26-A01-01 |3 |&bullet;&bullet;&bullet;ビジネスセグメントコード |1..1 |コード
|A26-A01-02 |3 |&bullet;&bullet;&bullet;ビジネスセグメント名 |1..1 |文字
|A26-A01-04 |3 |&bullet;&bullet;&bullet;組織タイプ |0..1 |文字
5+|Key H: 階層レベル
|=====

上記の意味構造を表現するための従来のアプローチは、多くの Codd の第 3 正規形の表を定義し、これらの表をリレーショナル データベースで接続することです。 
Tidy data(整然としたデータ)は、多数の接続されたデータセットではなく、単一のデータ セットに焦点を当てます。

== 第3正規型の表
次に示す表 6、表 7、表 8、表 9、および表 10 は、第3正規型の表です。これを 1 つのTidy data(整然としたデータ)としてまとめます。

.総勘定元帳
[cols="3,^1,5,^1,3", options="header"]
|=====
^|ID ^|H ^|項目 ^|繰返 ^|データ型
|A25 |0 |総勘定元帳 |0..n |*集約*
|A25-01 |1 |&bullet;仕訳ID |1..1 |識別子
|A25-02 |1 |&bullet;仕訳番号 |0..1 |コード
|A25-09 |1 |&bullet;摘要 |0..1 |文字
|A25-10 (A25-A26) |1 |&bullet;総勘定元帳明細行 |1..n |*集約*
5+|Key H: 階層レベル
|=====

.総勘定元帳 Line
[cols="3,^1,5,^1,3", options="header"]
|=====
^|ID ^|H ^|項目 ^|繰返 ^|データ型
|A26 |0 |総勘定元帳明細行 |0..n |*集約*
|A26-03 (A26-A09) |1 |&bullet;勘定科目 |1..1 |*集約*
|A26-06 |1 |&bullet;日付 |0..1 |日付
|A26-08 |1 |&bullet;仕訳タイプコード |0..1 |コード
|A26-07 |1 |&bullet;明細行番号 |0..1 |コード
|A26-10 |1 |&bullet;明細行摘要 |0..1 |文字
|A26-11 |1 |&bullet;源コード |0..1 |コード
|A26-12 |1 |&bullet;書類番号 |0..1 |コード
|A26-14 |1 |&bullet;書類日付 |0..1 |日付
|A26-27 |1 |&bullet;貸借区分 |0..1 |コード
|A26-18 (A26-A89) |1 |&bullet;多通貨金額 |1..1 |*集約*
|A26-41 (A26-A01) |1 |&bullet;ビジネスセグメント |1..n |*集約*
5+|Key H: 階層レベル
|=====

.勘定科目
[cols="3,^1,5,^1,3", options="header"]
|=====
^|ID ^|H ^|項目 ^|繰返 ^|データ型
|A09 |0 |勘定科目 |0..n |*集約*
|A09-01 |1 |&bullet;勘定科目番号 |1..1 |識別子
|A09-02 |1 |&bullet;勘定科目名 |0..1 |文字
|A09-05 |1 |&bullet;勘定科目タイプ |0..1 |コード
|A09-06 |1 |&bullet;補助科目タイプ |0..1 |コード
5+|Key H: 階層レベル
|=====

.多通貨金額
[cols="3,^1,5,^1,3", options="header"]
|=====
^|ID ^|H ^|項目 ^|繰返 ^|データ型
|A89 |0 |多通貨金額 |0..n |*集約*
|A89-01 |1 |&bullet;金額 |1..1 |金額
|A89-02 |1 |&bullet;通貨 |1..1 |コード
5+|Key H: 階層レベル
|=====

.ビジネスセグメント
[cols="3,^1,5,^1,3", options="header"]
|=====
^|ID ^|H ^|項目 ^|繰返 ^|データ型
|A01 |0 |ビジネスセグメント |0..n |*集約*
|A01-03 |1 |&bullet;ビジネスセグメント区分 |1..1 |コード
|A01-01 |1 |&bullet;ビジネスセグメントコード |1..1 |コード
|A01-02 |1 |&bullet;ビジネスセグメント名 |1..1 |文字
|A01-04 |1 |&bullet;組織タイプ |0..1 |文字
5+|Key H: 階層レベル
|=====

乱雑なデータセットの問題の整理は、Wickham<<_1>> で次のように指定されています。
— 列ヘッダーは値であり、変数名ではありません。 +
— 複数の変数が 1 つの列に格納されます。 +
— 変数は行と列の両方に格納されます。 +
— 複数の種類の観測単位が同じテーブルに格納されます。 +
— 1 つの観測単位が複数のテーブルに格納されます。

== Tidy data
表に含まれる _変数_ として集約表を検出することから始めます。
これらの集約表が、その値が複数繰り返すと指定されている場合、値を報告するための _変数_ が必要です。総勘定元帳には、複数の集約表、つまり、総勘定元帳、総勘定元帳明細、複数通貨金額、およびビジネスセグメントが含まれています。この例では、総勘定元帳が単一の通貨で記録されていて現地通貨は報告通貨でもあるので、多通貨金額の _変数_ は不要です。
したがって、次の 3 つの _変数_ が必要です。 +
— d_A25 総勘定元帳 +
— d_A26 総勘定元帳明細行 +
— d_A01 ビジネスセグメント +

次の表は、これらの3つの _変数_ と項目を列ヘッダーと値の列として使用して定義しれています。 3件の明細行に対応して d_A26 列に 1, 2, 3が指定されています。

.総勘定元帳のほぼTidy data(整然としたデータ)
[cols="3,^1,^1,3,3,4", options="header"]
|=====
|d_A25 ^|d_A26 ^|d_A01 |ID |項目 |値
|943-8-477 | | |A25-01 |仕訳ID |943-8-477
|943-8-477 | | |A25-A26-08 |仕訳タイプコード |entries
|943-8-477 | | |A25-A26-07 |仕訳明細行番号 |8-477
|943-8-477 | | |A25-A26-14 |書類日付 |2009-04-03
|943-8-477 | | |A25-A26-12 |書類番号 |manual
|943-8-477 | | |A25-A26-11 |源コード |gj
|943-8-477 | | |A25-09 |摘要 |General
|943-8-477 | | |A25-02 |仕訳番号 |134
|943-8-477 |1 | |A26-A09-01 |勘定科目番号 |754
|943-8-477 |1 | |A26-A09-02 |勘定科目名 |事務用消耗品費
|943-8-477 |1 | |A26-A09-05 |勘定科目タイプ |account
|943-8-477 |1 | |A25-A26-27 |貸借区分 |debit
|943-8-477 |1 | |A26-A89-01 |金額 |14858
|943-8-477 |1 | |A26-A89-02 |通貨 |ISO4217:JPY
|943-8-477 |1 | |A25-A26-06 |日付 |2009-04-03
|943-8-477 |1 | |A26-A09-06 |補助科目タイプ |proposed
|943-8-477 |1 | |A25-A26-10 |明細行摘要 |用紙
|943-8-477 |1 |1 |A26-A01-03 |ビジネスセグメント区分 |account sub
|943-8-477 |1 |1 |A26-A01-01 |ビジネスセグメントコード |10
|943-8-477 |1 |1 |A26-A01-02 |ビジネスセグメント名 |札幌
|943-8-477 |1 |1 |A26-A01-04 |組織タイプ |部門
|943-8-477 |2 | |A26-A09-01 |勘定科目番号 |191
|943-8-477 |2 | |A26-A09-02 |勘定科目名 |仮払消費税等
|943-8-477 |2 | |A26-A09-05 |勘定科目タイプ |account
|943-8-477 |2 | |A25-A26-27 |貸借区分 |debit
|943-8-477 |2 | |A26-A89-01 |金額 |742
|943-8-477 |2 | |A26-A89-02 |通貨 |ISO4217:JPY
|943-8-477 |2 | |A25-A26-06 |日付 |2009-04-03
|943-8-477 |2 | |A26-A09-06 |補助科目タイプ |tax
|943-8-477 |2 |1 |A26-A01-03 |ビジネスセグメント区分 |account sub
|943-8-477 |2 |1 |A26-A01-01 |ビジネスセグメントコード |10
|943-8-477 |2 |1 |A26-A01-02 |ビジネスセグメント名 |札幌
|943-8-477 |2 |1 |A26-A01-04 |組織タイプ |部門
|943-8-477 |3 | |A26-A09-01 |勘定科目番号 |111
|943-8-477 |3 | |A26-A09-02 |勘定科目名 |現金 Cash
|943-8-477 |3 | |A26-A09-05 |勘定科目タイプ |account
|943-8-477 |3 | |A25-A26-27 |貸借区分 |credit
|943-8-477 |3 | |A26-A89-01 |金額 |15600
|943-8-477 |3 | |A26-A89-02 |通貨 |ISO4217:JPY
|943-8-477 |3 | |A25-A26-06 |日付 |2009-04-03
|943-8-477 |3 | |A26-A09-06 |補助科目タイプ |proposed
|943-8-477 |3 | |A25-A26-10 |明細行摘要 |用紙
|943-8-477 |3 |1 |A26-A01-03 |ビジネスセグメント区分 |account sub
|943-8-477 |3 |1 |A26-A01-01 |ビジネスセグメントコード |0
|943-8-477 |3 |1 |A26-A01-02 |ビジネスセグメント名 |共通部門
|943-8-477 |3 |1 |A26-A01-04 |組織タイプ |部門
|=====

表 11 はほとんど整理されていますが、観測値には異なるデータ型の値が含まれています。 データ型が異なる列 Element の結果値です。 Tidy データは、測定変数の列数を制限しないことに注意してください。 各要素の変数の結果に追加の列を提供すると、Table 12がTidy data(整然としたデータ)です。

.総勘定元帳のTidy data(整然としたデータ)
[cols="1,>1,>1,^1,^1,^1,^1,^1,^1,^1,^1,^1,8,^1,^1,>1,1,1,1,1,1,^1,1,1", options="header"]
|========================
|d_A25 +
総勘定元帳 >|d_A26 +
総勘定元帳明細行 >|d_A01 +
ビジネスセグメント |A25-01 +
仕訳ID |A25-A26-08 +
タイプコード |A25-A26-07 +
仕訳明細行番号 |A25-A26-14 +
日付 |A25-A26-12 +
入力元 |A25-A26-11 +
情報源コード |A25-09 +
摘要 |A25-02 +
仕訳番号 |A26-A09-01 +
勘定科目番号 |A26-A09-02 +
勘定科目名 |A26-A09-05 +
勘定科目タイプ |A25-A26-27 +
貸借区分 |A26-A89-01 +
金額 |A26-A89-02 +
通貨 |A25-A26-06 +
日付 |A26-A09-06 +
補助科目タイプ |A25-A26-10 +
明細行摘要 |A26-A01-03 +
ビジネスセグメント区分 |A26-A01-01 +
ビジネスセグメントコード |A26-A01-02 +
ビジネスセグメント名 |A26-A01-04 +
組織タイプ
|943-8-477 |  |  |943-8-477 |entries |8-477 |2009-04-03 |manual |gj |General |134 |  |  |  |  |  |  |  |  |  |  |  |  |  
|943-8-477 |1 |  |  |  |  |  |  |  |  |  |754 |事務用消耗品費 |account |debit |14858 |JPY |2009-04-03 |proposed |用紙 |  |  |  | 
|943-8-477 |1 |1 |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |account sub |10 |札幌|部門
|943-8-477 |2 |  |  |  |  |  |  |  |  |  |191 |仮払消費税等 |account |debit |742 |JPY |2009-04-03 |tax |  |  |  |  | 
|943-8-477 |2 |1 |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |account sub |10 |札幌|部門
|943-8-477 |3 |  |  |  |  |  |  |  |  |  |111 |現金 |account |credit |15600 |JPY |2009-04-03 |proposed |用紙 |  |  |  | 
|943-8-477 |3 |1 |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |account sub |0 |共通部門 |部門
|========================

== xBRL-CSV
xBRL-CSV<<_2>>はこの形式のTidy data(整然としたデータ)をサポートしています。

.テストデータ [[data]]
PCA会計９V.2の仕訳データをXBRL-GL (XBRL 2.0a) に変換して出力したもので、架空の企業の１年間の記帳データ（2829件 31MB）
例 http://www.sambuichi.jp/xbrlgl/instances/0001-20091231-145-2109-1-4679.xml[xbrlgl/instances/0001-20091231-145-2109-1-4679.xml]  +
XBRL-GLの記事ページは、 https://www.sambuichi.jp/?p=345[こちら] です。 +

.今回の  Tidy Data:
.Arelle saveLoadableOIMで変換 (Table 11)
OIM-CSVデータ http://www.sambuichi.jp/xBRL-alpha/OIM/adc-instances2-facts.csv[adc-instances2-facts.csv] (18MB)  +
OIM-CSV定義 http://www.sambuichi.jp/xBRL-alpha/OIM/adc-instances2-metadata.json[adc-instances2-metadata.json] (1.1KB) 

.Tidy Data変換 (Table 12) -試作-
OIM-CSVデータ http://www.sambuichi.jp/xBRL-alpha/OIM/adc-instances.csv[adc-instances.csv] (2.4MB) **1/12以上容量削減** +
OIM-CSV定義 http://www.sambuichi.jp/xBRL-alpha/OIM/adc-instance.json[adc-instances.json] (4.6KB) 

.xBRLタクソノミはいづれも同じ
Schema http://www.sambuichi.jp/xBRL-alpha/GD/core.xsd[core.xsd] 
Definition Linkbase http://www.sambuichi.jp/xBRL-alpha/GD/core-def.xml[core-def.xml] 
Presentation Linkbase http://www.sambuichi.jp/xBRL-alpha/GD/core-pre.xml[core-pre.xml] 
Label Linkbase http://www.sambuichi.jp/xBRL-alpha/GD/core-label-en.xml[core-label-en.xml] 

== 参考資料
[1] [[_1]]  Tidy Data, Journal of Statistical Software, August 2014, Volume 59, Issue 10, Headley Wickham +
https://www.jstatsoft.org/article/view/v059i10 +
[2] [[_2]]  xBRL-CSV: CSV representation of XBRL data 1.0, Recommendation 13 October 2021 +
https://www.xbrl.org/Specification/xbrl-csv/REC-2021-10-13/xbrl-csv-REC-2021-10-13.html
